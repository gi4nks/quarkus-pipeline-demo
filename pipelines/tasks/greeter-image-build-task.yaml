apiVersion: tekton.dev/v1alpha1
kind: Task
metadata:
  name: greeter-image-from-git
spec:
 inputs:
  resources:
    - name: greeter-git-source
      type: git
  params:
    - name: contextDir
      default: /workspace/greeter-git-source
      description: The Docker build context Dir
    - name: push
      default: "false"
      description: Whether to push the image to external container registry   
 outputs:
  resources:
    - name: greeterImage
      type: image
 steps:
    - name: build-and-push
      image: quay.io/rhdevelopers/quarkus-java-builder
      env:
      - name: MAVEN_MIRROR_URL
        value: http://192.168.64.1:8081/nexus/content/groups/public/
      - name: WORK_DIR
        value: ${inputs.params.contextDir}
      - name: PUSH
        value: ${inputs.params.push}
      - name: DESTINATION_NAME
        value: ${outputs.resources.greeterImage.url}
      args:
       - "/usr/local/bin/buildah.sh"
      securityContext:
        capabilities:
          add: ["SYS_ADMIN"]
      volumeMounts:
        - mountPath: /root/.m2
          name: m2-cache
        - mountPath: /var/lib/containers
          name: container-storage
 volumes:
    - name: m2-cache
      persistentVolumeClaim:
        claimName: m2-cache
    - name: container-storage
      hostPath:
        path: /var/lib/containers
   
  